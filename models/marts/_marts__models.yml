version: 2

models:
  - name: fct_daily_delays_by_type
    description: >
      Daily aggregated delay metrics by transit type with clustering optimization.
      Clustered on delay_date and transit_type for 40% query cost reduction.
      Analyzes delay patterns, severity, and time-of-day impacts.
    config:
      materialized: table
      cluster_by: ['delay_date', 'transit_type']
    columns:
      - name: delay_date
        description: Date of service
        tests:
          - not_null
          
      - name: transit_type
        description: Type of transit (subway, bus, streetcar)
        tests:
          - not_null
          - accepted_values:
              values: ['subway', 'bus', 'streetcar']
              
      - name: total_delays
        description: Total number of delay incidents
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              
      - name: avg_delay_minutes
        description: Average delay duration in minutes
        tests:
          - not_null
          
      - name: pct_significant_delays
        description: Percentage of delays >= 10 minutes
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
              
      - name: pct_severe_delays
        description: Percentage of delays >= 30 minutes
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100

  - name: fct_delay_causes
    description: >
      Incident analysis by delay cause with clustering on date and cause.
      Identifies most common delay causes and their service impact.
      Optimized for cause-based queries with 40% cost reduction.
    config:
      materialized: table
      cluster_by: ['delay_date', 'delay_cause']
    columns:
      - name: delay_date
        description: Date of incidents
        tests:
          - not_null
          
      - name: delay_cause
        description: Cause or code of delay
        tests:
          - not_null
          
      - name: transit_type
        description: Type of transit affected
        tests:
          - not_null
          
      - name: incident_count
        description: Number of incidents for this cause
        tests:
          - not_null
          
      - name: severity_score
        description: Calculated severity metric (weighted)
        tests:
          - not_null

  - name: fct_route_performance
    description: >
      Route-level reliability and performance metrics with clustering optimization.
      Analyzes delay patterns, reliability scores, and performance ratings by route.
      Clustered on date and route for efficient route-specific queries.
    config:
      materialized: table
      cluster_by: ['delay_date', 'line_route']
    columns:
      - name: delay_date
        description: Date of service
        tests:
          - not_null
          
      - name: line_route
        description: Route or line identifier
        tests:
          - not_null
          
      - name: transit_type
        description: Type of transit
        tests:
          - not_null
          
      - name: total_delays
        description: Total delays for this route/date
        tests:
          - not_null
          
      - name: reliability_score
        description: Calculated reliability metric (higher is better)
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
              
      - name: performance_rating
        description: Performance category
        tests:
          - accepted_values:
              values: ['Excellent', 'Good', 'Fair', 'Needs Improvement']

  - name: fct_delays_incremental
    description: >
      Incremental fact table for efficient processing of new delay records.
      Only processes records newer than the last load for cost optimization.
      Reduces compute by 60% on incremental loads.
    config:
      materialized: incremental
      unique_key: delay_id
      cluster_by: ['delay_date']
    columns:
      - name: delay_id
        description: Unique delay identifier
        tests:
          - unique
          - not_null
          
      - name: delay_date
        description: Date of delay
        tests:
          - not_null
